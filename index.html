<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulario con GPS, Foto y Exportación</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <style>
    :root{--bg:#0b0c10;--card:#111218;--muted:#cbd5e1;--fg:#f8fafc;--accent:#22c55e;--accent2:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0b0c10,#111218);color:var(--fg)}
    header{padding:22px 16px;text-align:center}
    header h1{margin:0;font-size:clamp(20px,4vw,30px)}
    header p{color:var(--muted);margin:6px 0 0}
    .wrap{max-width:1150px;margin:0 auto;padding:14px}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;box-shadow:0 8px 28px rgba(0,0,0,.28)}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(12,minmax(0,1fr))}
    .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-6{grid-column:span 6}.col-12{grid-column:span 12}
    @media (max-width:900px){.col-3,.col-4,.col-6{grid-column:span 12}}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #263041;background:#0f1117;color:var(--fg);outline:none}
    input:focus,select:focus,textarea:focus{border-color:#334155;box-shadow:0 0 0 3px rgba(59,130,246,.18)}
    textarea{min-height:90px;resize:vertical}
    input::file-selector-button{border:none;background:#0f172a;color:var(--muted);padding:8px 10px;border-radius:10px;margin-right:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{cursor:pointer;border:none}
    .btn-primary{background:linear-gradient(180deg,var(--accent2),#1d4ed8)}
    .btn-success{background:linear-gradient(180deg,var(--accent),#16a34a)}
    .btn-danger{background:linear-gradient(180deg,#ef4444,#b91c1c)}
    .btn-ghost{background:#0f1117;border:1px solid #1f2937}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;color:var(--muted)}
    #map{height:260px;border-radius:12px;border:1px solid #1f2937}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:13px}
    th{background:#0f1117;text-align:left}
    tbody tr:hover{background:#0f1117}
    .thumb{width:48px;height:48px;object-fit:cover;border-radius:8px;border:1px solid #1f2937}
  </style>
</head>
<body>
  <header>
    <h1>Formulario — GPS, Foto y Exportación a Excel (CSV)</h1>
    <p>Captura de campo con almacenamiento local y exportación.</p>
  </header>
  <div class="wrap">
    <section class="card">
      <form id="form" class="grid" onsubmit="event.preventDefault();guardarRegistro();">
        <div class="col-6">
          <label for="nombre">Nombre</label>
          <input id="nombre" required placeholder="Ej. Juan" />
        </div>
        <div class="col-6">
          <label for="apellidos">Apellidos</label>
          <input id="apellidos" required placeholder="Ej. Pérez Ramírez" />
        </div>

        <div class="col-6">
          <label for="calle">Nombre de calle</label>
          <input id="calle" required placeholder="Ej. Av. Hidalgo" />
        </div>
        <div class="col-3">
          <label for="numextint">Num Ext-Int</label>
          <input id="numextint" required placeholder="123 o 123-2" />
        </div>
        <div class="col-3">
          <label for="colonia">Colonia</label>
          <input id="colonia" required placeholder="Ej. Del Valle" />
        </div>
        <div class="col-6">
          <label for="entrecalles">Entrecalles</label>
          <input id="entrecalles" placeholder="Ej. Allende y Juárez" />
        </div>

        <div class="col-3">
          <label for="telefono">Teléfono (10 dígitos)</label>
          <input id="telefono" inputmode="numeric" pattern="^\d{10}$" placeholder="8331234567" />
        </div>
        <div class="col-3">
          <label for="seccional">Seccional</label>
          <input id="seccional" placeholder="Ej. 1234" />
        </div>
        <div class="col-3">
          <label for="sexo">Sexo</label>
          <select id="sexo">
            <option value="">—</option>
            <option>Masculino</option>
            <option>Femenino</option>
          </select>
        </div>
        <div class="col-3">
          <label for="discapacidad">Discapacidad</label>
          <select id="discapacidad">
            <option value="">—</option>
            <option>Sí</option>
            <option>No</option>
          </select>
        </div>

        <div class="col-6">
          <label>Ubicación GPS</label>
          <div class="row">
            <button type="button" class="btn btn-primary" onclick="obtenerGPS()">Obtener ubicación</button>
            <span id="gpsBadge" class="pill">Lat: —, Lng: —</span>
          </div>
          <p style="margin:.4rem 0 0;color:#cbd5e1;font-size:12px">Si ves “user denied geolocation”: abre por <strong>HTTPS</strong> (GitHub Pages) o <strong>localhost</strong> y concede permiso. También puedes <strong>tocar el mapa</strong> para fijar la ubicación manualmente.</p>
          <input id="lat" type="hidden" />
          <input id="lng" type="hidden" />
        </div>
        <div class="col-6">
          <label for="foto">Foto (cámara o galería)</label>
          <input id="foto" type="file" accept="image/*" capture="environment" />
        </div>

        <div class="col-12">
          <label for="obs">Observaciones</label>
          <textarea id="obs" placeholder="Escribe observaciones"></textarea>
        </div>

        <div class="col-12"><div id="map"></div></div>

        <div class="col-12 row" style="margin-top:8px">
          <button class="btn btn-success" type="submit">Guardar registro</button>
          <button class="btn btn-ghost" type="button" onclick="limpiarFormulario()">Limpiar</button>
        </div>
      </form>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="row">
        <button class="btn btn-primary" onclick="exportarCSV()">Exportar a Excel (CSV)</button>
        <button class="btn btn-ghost" onclick="exportarJSON()">Exportar JSON</button>
        <button class="btn btn-danger" onclick="borrarTodo()">Borrar todos</button>
        <span class="pill" id="contador">0 registros</span>
      </div>
      <table id="tabla">
        <thead>
          <tr>
            <th>#</th>
            <th>Fecha/Hora</th>
            <th>Nombre</th>
            <th>Apellidos</th>
            <th>Calle</th>
            <th>Num Ext-Int</th>
            <th>Colonia</th>
            <th>Entrecalles</th>
            <th>Teléfono</th>
            <th>Seccional</th>
            <th>Sexo</th>
            <th>Discapacidad</th>
            <th>Lat</th>
            <th>Lng</th>
            <th>Foto</th>
            <th>Obs.</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p style="color:#cbd5e1;font-size:12px;margin-top:8px">Los datos se guardan en este navegador (LocalStorage). Puedes exportarlos cuando lo necesites.</p>
    </section>
  </div>

  <script>
    const KEY='registros_gps_form_v2';
    let registros=[]; let map, marker;

    const $=id=>document.getElementById(id);

    function init(){
      cargar();
      initMapa();
    }

    function cargar(){
      try{registros=JSON.parse(localStorage.getItem(KEY))||[]}catch{registros=[]}
      renderTabla();
    }
    function persistir(){
      localStorage.setItem(KEY, JSON.stringify(registros));
      actualizarContador();
    }
    function actualizarContador(){
      $('contador').textContent = `${registros.length} registro${registros.length!==1?'s':''}`;
    }

    // Mapa / GPS
    function initMapa(){
      map = L.map('map').setView([22.2331,-97.8611],12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'© OpenStreetMap'}).addTo(map);
      map.on('click',e=>{
        const {lat,lng}=e.latlng; setLatLng(lat,lng);
      });
    }
    function setLatLng(lat,lng){
      $('lat').value = Number(lat).toFixed(6);
      $('lng').value = Number(lng).toFixed(6);
      $('gpsBadge').textContent = `Lat: ${$('lat').value}, Lng: ${$('lng').value}`;
      if(marker) marker.remove();
      marker = L.marker([lat,lng]).addTo(map);
      map.setView([lat,lng],17);
    }
    function obtenerGPS(){
      if(!(location.protocol==='https:' || location.hostname==='localhost' || location.hostname==='127.0.0.1')){
        alert('Para usar GPS, abre la página con HTTPS (GitHub Pages) o en localhost.'); return;
      }
      if(!('geolocation' in navigator)){alert('Tu navegador no soporta geolocalización.');return}
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude,longitude}=pos.coords; setLatLng(latitude,longitude);
      },err=>{
        let msg='No se pudo obtener la ubicación.';
        if(err.code===1) msg+='\nMotivo: permiso denegado por el usuario.';
        else if(err.code===2) msg+='\nMotivo: servicio no disponible.';
        else if(err.code===3) msg+='\nMotivo: tiempo de espera agotado.';
        msg+='\n\nSugerencia: habilita permisos o toca el mapa para fijar la ubicación manualmente.';
        alert(msg);
      },{enableHighAccuracy:true,timeout:15000,maximumAge:0});
    }

    // Utilidades
    function esc(s){return (s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}

    async function fileToResizedDataURL(file,maxLado=1024){
      if(!file) return null;
      const data = await new Promise((res,rej)=>{const r=new FileReader();r.onload=e=>res(e.target.result);r.onerror=rej;r.readAsDataURL(file)});
      return new Promise(resolve=>{
        const img=new Image();
        img.onload=()=>{
          let {width:w,height:h}=img; const canvas=document.createElement('canvas');
          if(w>h && w>maxLado){h=Math.round(h*(maxLado/w)); w=maxLado}
          else if(h>=w && h>maxLado){w=Math.round(w*(maxLado/h)); h=maxLado}
          canvas.width=w; canvas.height=h; const ctx=canvas.getContext('2d');
          ctx.drawImage(img,0,0,w,h); resolve(canvas.toDataURL('image/jpeg',0.8));
        };
        img.src=data;
      });
    }

    // Guardar registro
    async function guardarRegistro(){
      // Validaciones básicas
      if(!$('nombre').value.trim()||!$('apellidos').value.trim()||!$('calle').value.trim()||!$('numextint').value.trim()||!$('colonia').value.trim()){
        alert('Completa: Nombre, Apellidos, Calle, Num Ext-Int y Colonia.'); return;
      }
      const tel=$('telefono').value.trim(); if(tel && !/^\d{10}$/.test(tel)){alert('Teléfono debe tener 10 dígitos.');return}

      const fotoFile=$('foto').files[0];
      const fotoData= await fileToResizedDataURL(fotoFile,1024);

      const ahora = new Date();
      const rec={
        id: crypto.randomUUID(),
        fechaISO: ahora.toISOString(),
        fechaLocal: formatearFechaLocal(ahora),
        nombre: $('nombre').value.trim(),
        apellidos: $('apellidos').value.trim(),
        calle: $('calle').value.trim(),
        numextint: $('numextint').value.trim(),
        colonia: $('colonia').value.trim(),
        entrecalles: $('entrecalles').value.trim(),
        telefono: tel,
        seccional: $('seccional').value.trim(),
        sexo: $('sexo').value,
        discapacidad: $('discapacidad').value,
        lat: $('lat').value||'',
        lng: $('lng').value||'',
        obs: $('obs').value.trim(),
        foto: fotoData || ''
      };
      registros.push(rec); persistir(); renderTabla(); limpiarFormulario(true);
    }

    function limpiarFormulario(silent){
      $('form').reset(); $('lat').value=''; $('lng').value=''; $('gpsBadge').textContent='Lat: —, Lng: —';
      if(!silent) alert('Formulario limpio.');
    }

    function eliminar(id){
      if(!confirm('¿Eliminar este registro?')) return;
      registros = registros.filter(r=>r.id!==id); persistir(); renderTabla();
    }

    function renderTabla(){
      const tbody=document.querySelector('#tabla tbody'); tbody.innerHTML='';
      registros.forEach((r,idx)=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${idx+1}</td>
          <td title="${esc(r.fechaISO)}">${esc(r.fechaLocal)}</td>
          <td>${esc(r.nombre)}</td>
          <td>${esc(r.apellidos)}</td>
          <td>${esc(r.calle)}</td>
          <td>${esc(r.numextint)}</td>
          <td>${esc(r.colonia)}</td>
          <td>${esc(r.entrecalles)}</td>
          <td>${esc(r.telefono)}</td>
          <td>${esc(r.seccional)}</td>
          <td>${esc(r.sexo)}</td>
          <td>${esc(r.discapacidad)}</td>
          <td>${esc(r.lat)}</td>
          <td>${esc(r.lng)}</td>
          <td>${r.foto?`<img class="thumb" src="${r.foto}">`:''}</td>
          <td title='${esc(r.obs)}'>${esc(r.obs).slice(0,30)}${r.obs && r.obs.length>30?'…':''}</td>
          <td><button class="btn btn-danger" onclick="eliminar('${r.id}')">Eliminar</button></td>`;
        tbody.appendChild(tr);
      });
      actualizarContador();
    }

    // Exportar CSV / JSON
    function exportarCSV(){
      if(!registros.length){alert('No hay registros.');return}
      const headers=[
        'fecha_local','fecha_iso','nombre','apellidos','calle','num_ext_int','colonia','entrecalles','telefono','seccional','sexo','discapacidad','lat','lng','observaciones','foto_base64'
      ];
      const rows=registros.map(r=>[
        r.fechaLocal,r.fechaISO,r.nombre,r.apellidos,r.calle,r.numextint,r.colonia,r.entrecalles,r.telefono,r.seccional,r.sexo,r.discapacidad,r.lat,r.lng,r.obs,r.foto
      ]);
      const csv=[headers,...rows].map(row=>row.map(csvEsc).join(',')).join('\n');
      descargar(csv,`registros_${stamp()}.csv`,'text/csv;charset=utf-8;');
    }
    function csvEsc(v){ if(v==null) return ''; const s=String(v).replace(/\r?\n/g,' '); return /[",\n]/.test(s) ? '"'+s.replace(/"/g,'""')+'"' : s; }
    function exportarJSON(){ if(!registros.length){alert('No hay registros.');return} descargar(JSON.stringify(registros,null,2),`registros_${stamp()}.json`,'application/json') }
    function descargar(contenido,nombre,tipo){ const blob=new Blob([contenido],{type:tipo}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=nombre;a.click(); setTimeout(()=>URL.revokeObjectURL(url),5000); }
    function stamp(){ const d=new Date(),p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}` }

    function formatearFechaLocal(d){
      try{ return d.toLocaleString(undefined,{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}) }catch{ return d.toISOString() }
    }

    function borrarTodo(){ if(!registros.length){alert('No hay registros.');return} if(!confirm('¿Borrar TODOS los registros?'))return; registros=[]; persistir(); renderTabla(); }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
